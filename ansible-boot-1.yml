---
- hosts: localhost
  connection: local
  vars:
    zerotier_cli_pkg: "{{ 'zerotier-cli' if ansible_os_family == 'Darwin' else 'zerotier-one' }}"
    additional_pkgs:
      - neofetch
      - mtr
      - nmap
      - bpython
      - zsh
      # - terraform
      - git
      - python3
  tasks:
    - name: Update package manager.
      package:
        update_cache: yes

    - name: Install Zerotier-CLI
      shell: curl -s https://install.zerotier.com/ | sudo bash
      ignore_errors: true
      register: zt_install_log

    - name: Join Zerotier network
        block:
          shell: zerotier-cli join {{ network_id }}
          register: join_output
          ignore_errors: true
        rescue:
          - debug:
              msg: "Install Zerotier-CLI failed"
        dependencies:
          - Install Zerotier-CLI

    - name: Debug output
      debug:
        var: join_output
      when: join_output.stdout is defined

    - name: Add Zerotier-CLI to system startup
        block: 
          copy:
            src: zerotier-cli
          msg: "Zerotier-CLI added to startup"
        rescue:
          - debug:
              msg: "Install Zerotier-CLI failed"
        dependencies:
          - Install Zerotier-CLI

    - name: Install additional packages
      package:
        name: "{{ item }}"
        state: present
      loop: "{{ additional_pkgs }}"

    - name: Install Oh My Zsh
      shell: sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
      when: ansible_os_family == "Darwin" or ansible_os_family == "Debian"


  handlers:
    - name: Reload systemctl daemon
      systemd:
        daemon_reload: yes



